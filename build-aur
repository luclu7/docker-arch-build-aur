#!/usr/bin/env bash

set -e

if [ "$#" -ne 1 ]; then
  echo -e "Please provide AUR package name to build\nUsage: docker run --rm -v \$(pwd):/pkg maximbaz/arch-build-aur /bin/bash -c '/build-aur <package-name>'"
  exit 1
fi

package=$1

chown -R makepkg:users /build

sudo -u makepkg git clone --depth 1 https://aur.archlinux.org/"$package".git /build

/build-pkgbuild


cd /pkg

urls=()

json_array() {
  echo -n '['
  while [ $# -gt 0 ]; do
    x=${1//\\/\\\\}
    print -n \""${x//\"/\\\"}"\"
    [ $# -gt 1 ] && echo -n ', '
    shift
  done
  echo ']'
}


for i in *
do
	curl -X POST -H "Content-Type: application/octet-stream" --data-binary "@$i" "$MAIN_HOST"/upload\?name="$i"
	/easiest-minio-uploader "$S3_BUCKET" "$1" "$package"/"$1"
	urls+=("$S3_HOST/$S3_BUCKET/$package/$1")
done	

echo urls

json=$(json_array "${urls[@]}")

curl "$MAIN_HOST"/build/complete/mark/"$package"?urls="$json"
